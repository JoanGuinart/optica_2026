---
import NavbarClient from "@/components/NavbarClient";
import "@styles/global.css";
import contactData from "@/data/contact.json";

export interface Props {
  title?: string;
  description?: string;
  ogImage?: string;
  noindex?: boolean;
}

const defaultTitle = "Òptica y Audiología Guinart Sant Andreu Barcelona";
const defaultDescription =
  "Òptica y audiología en Sant Andreu (Barcelona). Revisiones visuales, gafas graduadas, lentillas, adaptación de audífonos y salud auditiva con más de 25 años de experiencia.";
const defaultImage = "/portada/portada_compressed_2.webp";

const {
  title = defaultTitle,
  description = defaultDescription,
  ogImage = defaultImage,
  noindex = false,
} = Astro.props as Props;
// Title template: añade el nombre del sitio si la página tiene título personalizado
const siteName = "Óptica Guinart";
const fullTitle = title && title !== defaultTitle ? `${title} | ${siteName}` : title;
// Asegurar que ogImage sea una URL absoluta cuando sea una ruta relativa y `Astro.site` esté definido
const ogImageUrl =
  Astro.site && typeof ogImage === "string" && ogImage.startsWith("/")
    ? new URL(ogImage, Astro.site).toString()
    : ogImage;
// Dimensiones OG si la imagen por defecto coincide (mejora de previews)
const ogImageDims = ogImageUrl?.includes("portada_compressed_2.webp")
  ? { width: 1526, height: 994 }
  : null;
// sameAs array limpio (solo URLs existentes)
const sameAs = [
  contactData?.socialMedia?.instagram?.url,
  contactData?.socialMedia?.facebook?.url,
  contactData?.socialMedia?.google?.url,
].filter(Boolean);
// Construir URL canónica absoluta si 'site' está definido en astro.config.mjs
const canonical = Astro.site
  ? new URL(Astro.url.pathname.replace(/index\.html$/, ""), Astro.site)
      .toString()
      .replace(/\/$/, Astro.url.pathname.endsWith("/") ? "/" : "")
  : Astro.url;
const robotsContent = noindex
  ? "noindex,nofollow"
  : "index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1";
// URL de Google Maps para hasMap (si existe en contactData)
const googleMapsUrl =
  contactData?.contactInfo?.address?.googleMaps ||
  contactData?.socialMedia?.google?.url;
// Raíz del sitio para JSON-LD WebSite
const siteRoot = Astro.site
  ? new URL("/", Astro.site).toString()
  : typeof canonical === "string"
    ? canonical
    : String(canonical);

// Breadcrumbs (visible + JSON-LD)
const path = Astro.url.pathname.replace(/\/$/, "");
const segments = path === "" || path === "/" ? [] : path.split("/").filter(Boolean);
const breadcrumbs = [
  { name: "Inicio", url: siteRoot },
  ...segments.map((seg, i) => {
    const name = decodeURIComponent(seg)
      .replace(/-/g, " ")
      .replace(/\b\w/g, (c) => c.toUpperCase());
    const url = new URL("/" + segments.slice(0, i + 1).join("/") + "/", siteRoot).toString();
    return { name, url };
  }),
];
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- SEO Meta Tags -->
  <title>{fullTitle}</title>
  <meta name="description" content={description} />
    <!-- Aunque 'keywords' ya no es determinante, mantenemos una lista semántica para buscadores secundarios -->
    <meta
      name="keywords"
      content="optica, óptica, audiologia, audiología, guinart, óptica barcelona, óptica sant andreu, gafas graduadas, lentillas, audifonos, audífonos, revisión visual, examen vista, adaptación audífonos"
    />
    <meta name="author" content="Óptica Guinart" />
    <meta name="robots" content={robotsContent} />
    <meta name="language" content="es" />
    <meta name="distribution" content="global" />
    <meta name="geo.region" content="ES-B" />
    <meta name="geo.placename" content="Barcelona" />
    <meta name="geo.position" content="41.4372;2.1896" />
    <meta name="ICBM" content="41.4372, 2.1896" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
  <meta property="og:url" content={canonical} />
  <meta property="og:title" content={fullTitle} />
  <meta property="og:description" content={description} />
  <meta property="og:image" content={ogImageUrl} />
    {ogImageDims && (
      <>
        <meta property="og:image:width" content={String(ogImageDims.width)} />
        <meta property="og:image:height" content={String(ogImageDims.height)} />
        <meta name="twitter:image:width" content={String(ogImageDims.width)} />
        <meta name="twitter:image:height" content={String(ogImageDims.height)} />
      </>
    )}
    <meta property="og:site_name" content="Óptica Guinart" />
    <meta property="og:locale" content="es_ES" />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonical} />
    <meta property="twitter:title" content={fullTitle} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={ogImageUrl} />
    <!-- Twitter site/creator (si se dispone) -->
    {contactData?.socialMedia?.instagram?.text && (
      <meta name="twitter:creator" content={contactData.socialMedia.instagram.text} />
    )}

    <!-- Canonical URL -->
  <link rel="canonical" href={canonical} />

    <!-- Favicon y otros -->
    <!-- Añadimos un parámetro de versión para forzar actualización en cachés (Google favicon cache) -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg?v=2" />
    <!-- Soporte Safari pinned-tab (usa el SVG como máscara) -->
    <link rel="mask-icon" href="/favicon.svg" color="#065f46" />
    <meta name="generator" content={Astro.generator} />
    <meta name="theme-color" content="#065f46" />
  <meta name="format-detection" content="telephone=no,address=no,email=no" />
    <link rel="alternate" hreflang="es-ES" href={canonical} />

    <!-- Preload critical resources -->
    <link
      rel="preload"
      href="/portada/portada_compressed_2.webp"
      as="image"
      fetchpriority="high"
    />

    <!-- Preload critical JavaScript modules -->
    <!-- Los nombres de archivos se generan dinámicamente en desarrollo -->

    <!-- DNS prefetch y preconnect para recursos externos -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <!-- Web App Manifest & Icons -->
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png" />
  <link rel="icon" sizes="192x192" href="/icons/icon-192.png" />
  <link rel="icon" sizes="512x512" href="/icons/icon-512.png" />

    <!-- CSS crítico optimizado - Astro maneja el resto automáticamente -->

    <!-- Solo CSS crítico mínimo inline -->
    <style>
      /* Evitar layout shift crítico */
      main {
        margin-top: 80px;
      }
      body {
        scroll-behavior: smooth;
      }
      .navbar-height {
        height: 80px;
      }
    </style>

    <!-- Structured Data (JSON-LD) dinámico usando contactData -->
    <script
      type="application/ld+json"
      is:inline
      set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "Optician",
        name: "Óptica y Audiología Guinart",
        description,
        image: ogImageUrl,
        url: canonical,
        "@id": canonical,
        telephone: contactData.contactInfo.phone.display
          .replace(/\s+/g, "")
          .replace(/^\+34/, "+34 "),
        email: contactData.contactInfo.email.address,
        address: {
          "@type": "PostalAddress",
          streetAddress: contactData.contactInfo.address.street,
          addressLocality: "Barcelona",
          addressRegion: "Cataluña",
          postalCode: "08030",
          addressCountry: "ES",
        },
        geo: {
          "@type": "GeoCoordinates",
          latitude: 41.4372,
          longitude: 2.1896,
        },
        openingHoursSpecification: [
          {
            "@type": "OpeningHoursSpecification",
            dayOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
            opens: "09:30",
            closes: "13:30",
          },
          {
            "@type": "OpeningHoursSpecification",
            dayOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
            opens: "17:00",
            closes: "20:30",
          },
          {
            "@type": "OpeningHoursSpecification",
            dayOfWeek: ["Saturday"],
            opens: "10:00",
            closes: "13:30",
          },
        ],
        sameAs,
        priceRange: "€€",
        areaServed: { "@type": "City", name: "Barcelona" },
        hasMap: googleMapsUrl,
        contactPoint: [
          {
            "@type": "ContactPoint",
            telephone:
              "+" +
              (contactData.socialMedia.whatsapp.url.match(/wa\.me\/(\d+)/)?.[1] ||
                contactData.contactInfo.phone.display.replace(/\D/g, "")),
            contactType: "customer service",
            areaServed: "ES",
            availableLanguage: ["es"],
          },
        ],
      })}
    />

    <!-- Structured Data (WebSite + SearchAction) -->
    <script
      type="application/ld+json"
      is:inline
      set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "WebSite",
        "@id": siteRoot.replace(/\/$/, "") + "#website",
        url: siteRoot,
        name: "Óptica Guinart",
        potentialAction: {
          "@type": "SearchAction",
          target:
            siteRoot.replace(/\/$/, "") + "/products?q={search_term_string}",
          "query-input": "required name=search_term_string",
        },
      })}
    />
    <!-- BreadcrumbList Structured Data -->
    {breadcrumbs.length > 1 && (
      <script
        type="application/ld+json"
        is:inline
        set:html={JSON.stringify({
          "@context": "https://schema.org",
          "@type": "BreadcrumbList",
          itemListElement: breadcrumbs.map((b, idx) => ({
            "@type": "ListItem",
            position: idx + 1,
            name: b.name,
            item: b.url,
          })),
        })}
      />
    )}
  </head>
  <body class="bg-white text-slate-900 transition-colors duration-300">
    <!-- Navbar crítico carga inmediatamente para LCP -->
    <NavbarClient client:load />
    {breadcrumbs.length > 1 && (
      <nav aria-label="Breadcrumb" class="px-4 py-2 text-sm text-slate-600">
        <ol class="flex flex-wrap gap-1">
          {breadcrumbs.map((b, i) => (
            <li class="flex items-center" typeof="ListItem" property="itemListElement">
              <a href={b.url} class="hover:text-emerald-700 font-medium" property="item" typeof="WebPage">
                <span property="name">{b.name}</span>
              </a>
              <meta property="position" content={String(i + 1)} />
              {i < breadcrumbs.length - 1 && <span class="mx-1">/</span>}
            </li>
          ))}
        </ol>
      </nav>
    )}
    <main>
      <slot />
    </main>
  </body>
</html>
